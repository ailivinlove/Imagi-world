<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ðŸŒ€ IMAGI-WORLD ðŸŒ€</title>
    <style>
        :root {
            --gold: linear-gradient(to right, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
            --bg: #030308;
            --panel: #0d1117;
            --accent: #ffd700;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: var(--bg); 
            color: #eee; 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 15px;
            overflow-x: hidden;
        }

        /* SHINY STAR GOLD TITLE */
        h1 { 
            margin: 15px 0; 
            font-size: clamp(1.8rem, 8vw, 3rem); 
            text-align: center; 
            letter-spacing: 4px;
            font-weight: 900;
            background: var(--gold);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.7));
            text-transform: uppercase;
            animation: shimmer 5s infinite linear;
            background-size: 200% auto;
        }

        @keyframes shimmer { to { background-position: 200% center; } }

        .container { max-width: 600px; width: 100%; }

        .controls { 
            background: var(--panel); 
            padding: 20px; 
            border-radius: 20px; 
            margin-bottom: 15px; 
            border: 1px solid #222; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
        }

        .control-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-weight: bold; color: var(--accent); font-size: 0.75rem; text-transform: uppercase; }

        input[type="range"] { width: 100%; height: 10px; background: #1a1a2e; border-radius: 5px; outline: none; -webkit-appearance: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 24px; height: 24px; background: #ffd700; border-radius: 50%; box-shadow: 0 0 10px #ffd700; }

        select { 
            width: 100%; padding: 12px; background: #05050a; color: #fff; 
            border: 1px solid #444; border-radius: 10px; font-size: 0.95rem; 
        }

        .button-group { display: flex; gap: 10px; margin-top: 10px; }
        button { 
            padding: 15px; border-radius: 12px; border: none; font-weight: 900; 
            cursor: pointer; transition: 0.2s; text-transform: uppercase; 
            touch-action: manipulation;
        }

        #start-btn { flex: 2; background: linear-gradient(135deg, #ffd700, #b38728); color: #000; }
        #stop-btn { flex: 1; background: #1a1a2e; color: #e94560; border: 1px solid #e94560; }
        button:disabled { opacity: 0.2; }

        .game-area { 
            background: #080810; padding: 25px; border-radius: 25px; 
            text-align: center; border: 1px solid #16213e; min-height: 380px; 
            display: flex; flex-direction: column; justify-content: space-between; 
        }

        .status { font-size: 0.7rem; color: #444; letter-spacing: 3px; font-weight: bold; }
        
        .premise-display { 
            font-size: 1.6rem; color: #fff; margin: 20px 0; font-style: italic; 
            min-height: 100px; display: flex; align-items: center; justify-content: center; 
            line-height: 1.4; text-shadow: 0 0 15px rgba(255,255,255,0.1);
        }

        /* IPHONE ERGONOMIC BUTTONS */
        .response-buttons { 
            display: flex; 
            flex-direction: column; /* Mobile stack by default */
            gap: 15px; 
            width: 100%; 
        }

        @media (min-width: 500px) {
            .response-buttons { flex-direction: row; }
        }

        .response-buttons button { 
            flex: 1; padding: 25px; font-size: 1.4rem; border: 2px solid transparent; 
        }

        #match-btn { background: rgba(46, 204, 113, 0.1); color: #2ecc71; border-color: #2ecc71; }
        #no-match-btn { background: rgba(231, 76, 60, 0.1); color: #e74c3c; border-color: #e74c3c; }
        
        #match-btn:active { background: #2ecc71; color: #000; }
        #no-match-btn:active { background: #e74c3c; color: #fff; }

        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 25px; }
        .stat-box { background: #0d1117; padding: 12px; border-radius: 12px; border: 1px solid #222; }
        .stat-label { font-size: 0.6rem; color: #555; text-transform: uppercase; }
        .stat-value { font-size: 1.2rem; font-weight: bold; color: #ffd700; }

        #feedback { font-size: 1.2rem; font-weight: 900; min-height: 24px; }
        .correct { color: #ffd700; }
        .incorrect { color: #e94560; }
    </style>
</head>
<body>

<main class="container">
    <h1>IMAGI-WORLD</h1>
    
    <div class="controls">
        <div class="control-group">
            <label>Working Memory Lag: <span id="n-val" style="color:#ffd700">1</span></label>
            <input type="range" id="n-slider" min="1" max="5" value="1">
        </div>

        <div class="control-group">
            <label>Topology Geometry:</label>
            <select id="logic-mode">
                <option value="0">Mode 0: Linear Vector (2 Nodes)</option>
                <option value="1">Mode 1: Superposition (Orthogonal)</option>
                <option value="2">Mode 2: Tensor (Intersection)</option>
                <option value="3">Mode 3: Homology (Isomorphism)</option>
                <option value="4">Mode 4: Interface (Path-Linking)</option>
            </select>
        </div>

        <div class="control-group">
            <label>Cycle Speed: <span id="spt-val" style="color:#ffd700">8.0</span>s</label>
            <input type="range" id="spt-slider" min="2" max="25" step="0.5" value="8.0">
        </div>

        <div class="button-group">
            <button id="start-btn">Begin Session</button>
            <button id="stop-btn" disabled>Stop</button>
        </div>
    </div>

    <div class="game-area">
        <div id="status" class="status">IDLE_SYSTEM</div>
        <div id="feedback"></div>
        <div id="premise-display">AWAITING_INITIALIZATION</div>
        
        <div class="response-buttons">
            <button id="match-btn" disabled>MATCH</button>
            <button id="no-match-btn" disabled>NO_MATCH</button>
        </div>

        <div class="stats">
            <div class="stat-box"><div class="stat-label">Cycle</div><div id="trial-count" class="stat-value">0</div></div>
            <div class="stat-box"><div class="stat-label">Sync</div><div id="score" class="stat-value">0</div></div>
            <div class="stat-box"><div class="stat-label">Prec</div><div id="accuracy" class="stat-value">0%</div></div>
        </div>
    </div>
</main>

<script type="module">
    // SYMBOL POOL - ABSOLUTELY NO 'A'
    const SYMBOLS = "BCDEFGHJKLMNOPQRSTUVWXYZ".split(""); 
    const REL = { N: 'north', S: 'south', E: 'east', W: 'west' };

    class Mulberry32 {
        constructor(seed) { this.state = seed >>> 0; }
        next() {
            let t = this.state += 0x6D2B79F5;
            t = Math.imul(t ^ t >>> 15, t | 1);
            t ^= t + Math.imul(t ^ t >>> 7, t | 61);
            return ((t ^ t >>> 14) >>> 0) / 4294967296;
        }
        choice(arr) { return arr[Math.floor(this.next() * arr.length)]; }
    }

    class DaVinciEngine {
        constructor() {
            this.history = [];
            this.score = 0;
            this.total = 0;
            this.running = false;
            this.rng = new Mulberry32(Date.now());
            this.synth = window.speechSynthesis;
        }

        init() {
            document.getElementById('start-btn').onclick = () => this.start();
            document.getElementById('stop-btn').onclick = () => this.stop();
            document.getElementById('n-slider').oninput = (e) => document.getElementById('n-val').textContent = e.target.value;
            document.getElementById('spt-slider').oninput = (e) => document.getElementById('spt-val').textContent = e.target.value;
            document.getElementById('match-btn').onclick = () => this.respond(true);
            document.getElementById('no-match-btn').onclick = () => this.respond(false);
        }

        speak(t) {
            this.synth.cancel();
            const u = new SpeechSynthesisUtterance(t);
            u.rate = 0.9;
            this.synth.speak(u);
        }

        generate(mode, forceMatchKey = null) {
            const rS = () => {
                let s = this.rng.choice(SYMBOLS);
                // Secondary internal safety: Never allow 'A'
                return s === 'A' ? 'B' : s;
            };
            const rD = () => this.rng.choice(['N', 'S', 'E', 'W']);
            const ortho = (d) => (d === 'N' || d === 'S') ? this.rng.choice(['E', 'W']) : this.rng.choice(['N', 'S']);

            let text, key;

            if (forceMatchKey) {
                key = forceMatchKey;
            } else {
                const d1 = rD(), d2 = ortho(d1), d3 = rD();
                switch(mode) {
                    case 1: key = `M1-${d1}-${d2}`; break;
                    case 2: key = `M2-${d1}-${d2}`; break;
                    case 3: key = `M3-${d1}-${d3}`; break;
                    case 4: key = `M4-${d1}${d2}-${rD()}${rD()}`; break;
                    default: key = `M0-${d1}`;
                }
            }

            const p = key.split('-');
            const m = p[0];
            let s1 = rS(), s2 = rS(), s3 = rS();
            while(s2 === s1) s2 = rS();
            while(s3 === s1 || s3 === s2) s3 = rS();

            if (m === 'M1') text = `${s1} is ${REL[p[1]]} and ${REL[p[2]]} of ${s2}`;
            else if (m === 'M2') text = `${s1} is ${REL[p[1]]} of ${s2} and ${REL[p[2]]} of ${s3}`;
            else if (m === 'M3') text = `(${REL[p[1]]} of ${s1}) is ${REL[p[2]]} of (${REL[p[1]]} of ${s2})`;
            else if (m === 'M4') {
                const dA = p[1], dB = p[2];
                text = `(${REL[dA[0]]}-${REL[dA[1]]} of ${s1}) is ${REL[rD()]} of (${REL[dB[0]]}-${REL[dB[1]]} of ${s2})`;
            }
            else text = `${s1} is ${REL[p[1]]} of ${s2}`;

            return { text, key };
        }

        start() {
            this.running = true; this.score = 0; this.total = 0; this.history = [];
            document.getElementById('start-btn').disabled = true;
            document.getElementById('stop-btn').disabled = false;
            document.getElementById('match-btn').disabled = false;
            document.getElementById('no-match-btn').disabled = false;
            this.runCycle();
        }

        stop() {
            this.running = false;
            clearTimeout(this.timer);
            document.getElementById('start-btn').disabled = false;
            document.getElementById('stop-btn').disabled = true;
            document.getElementById('match-btn').disabled = true;
            document.getElementById('no-match-btn').disabled = true;
            document.getElementById('status').textContent = "SEVERED";
        }

        runCycle() {
            if (!this.running) return;
            const mode = parseInt(document.getElementById('logic-mode').value);
            const n = parseInt(document.getElementById('n-slider').value);
            
            const isMatchTrial = this.history.length >= n && this.rng.next() < 0.38;
            const nBackMatch = isMatchTrial ? this.history[this.history.length - n] : null;
            
            let current;
            let safety = 0;
            do {
                current = this.generate(mode, nBackMatch ? nBackMatch.key : null);
                safety++;
            } while (this.history.length > 0 && current.text === this.history[this.history.length-1].text && safety < 10);

            this.correctKey = nBackMatch ? nBackMatch.key : null;
            this.currentObj = current;

            document.getElementById('premise-display').textContent = current.text;
            this.speak(current.text);

            this.total++;
            this.updateUI();

            this.answered = false;
            const ms = parseFloat(document.getElementById('spt-slider').value) * 1000;
            this.timer = setTimeout(() => { if (!this.answered) this.respond(null); }, ms);
        }

        respond(val) {
            if (this.answered || !this.running) return;
            this.answered = true;
            clearTimeout(this.timer);

            const fb = document.getElementById('feedback');
            const isMatch = (this.correctKey !== null);

            if (val === null) {
                fb.textContent = "TIMEOUT"; fb.className = "incorrect";
            } else if (val === isMatch) {
                this.score++; fb.textContent = "SYNC_SUCCESS"; fb.className = "correct";
            } else {
                fb.textContent = "SYNC_ERROR"; fb.className = "incorrect";
            }

            this.history.push(this.currentObj);
            setTimeout(() => { fb.textContent = ""; this.runCycle(); }, 800);
        }

        updateUI() {
            document.getElementById('trial-count').textContent = this.total;
            document.getElementById('score').textContent = this.score;
            document.getElementById('accuracy').textContent = 
                this.total > 1 ? Math.round((this.score / (this.total - 1)) * 100) + "%" : "0%";
            document.getElementById('status').textContent = `CYCLE_${this.total}_UP`;
        }
    }

    const engine = new DaVinciEngine();
    engine.init();
</script>
</body>
</html>
