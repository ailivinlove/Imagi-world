<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ðŸŒ€ IMAGI-WORLD ðŸŒ€</title>
    <style>
        :root {
            --gold: linear-gradient(to right, #bf953f 0%, #fcf6ba 20%, #b38728 40%, #fbf5b7 60%, #aa771c 80%, #bf953f 100%);
            --bg: #010103;
            --panel: #0a0c10;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: var(--bg); 
            color: #eee; 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 10px;
            overflow-x: hidden;
            touch-action: manipulation;
        }

        /* SHINY STAR GOLD TITLE */
        h1 { 
            margin: 10px 0; 
            font-size: clamp(1.6rem, 9vw, 2.8rem); 
            text-align: center; 
            letter-spacing: 4px;
            font-weight: 900;
            background: var(--gold);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.8));
            text-transform: uppercase;
            animation: shimmer 6s infinite linear;
            background-size: 200% auto;
        }
        @keyframes shimmer { to { background-position: 200% center; } }

        .container { max-width: 500px; width: 100%; }

        .controls { 
            background: var(--panel); 
            padding: 20px; 
            border-radius: 20px; 
            margin-bottom: 15px; 
            border: 1px solid #1a1a1a; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.8); 
        }

        .control-group { margin-bottom: 12px; }
        label { display: block; margin-bottom: 4px; font-weight: bold; color: #ffd700; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; }

        input[type="range"] { width: 100%; height: 8px; background: #151921; border-radius: 4px; outline: none; -webkit-appearance: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 24px; height: 24px; background: #ffd700; border-radius: 50%; box-shadow: 0 0 10px #ffd700; border: 2px solid #000; }

        select { width: 100%; padding: 12px; background: #000; color: #fff; border: 1px solid #333; border-radius: 10px; font-size: 0.9rem; }

        .button-group { display: flex; gap: 10px; margin-top: 10px; }
        button { padding: 16px; border-radius: 12px; border: none; font-weight: 900; cursor: pointer; text-transform: uppercase; }

        #start-btn { flex: 2; background: linear-gradient(135deg, #ffd700, #b38728); color: #000; }
        #stop-btn { flex: 1; background: #121212; color: #e94560; border: 1px solid #301010; }
        button:disabled { opacity: 0.15; pointer-events: none; }

        .game-area { 
            background: #040406; padding: 20px; border-radius: 25px; 
            text-align: center; border: 1px solid #111; min-height: 480px; 
            display: flex; flex-direction: column; justify-content: space-between;
        }

        .status { font-size: 0.6rem; color: #444; letter-spacing: 3px; font-weight: 900; text-transform: uppercase; }
        
        /* COUNTDOWN OVERLAY */
        #countdown-display { font-size: 4rem; font-weight: 900; color: #ffd700; height: 60px; display: flex; align-items: center; justify-content: center; }

        .premise-display { 
            font-size: clamp(1.1rem, 4.2vw, 1.5rem); color: #fff; margin: 15px 0; font-style: italic; 
            min-height: 100px; display: flex; align-items: center; justify-content: center; 
            line-height: 1.5; text-shadow: 0 0 10px rgba(255,255,255,0.05);
        }

        /* IPHONE OPTIMIZED BUTTONS */
        .response-buttons { display: flex; flex-direction: column; gap: 12px; width: 100%; }
        @media (min-width: 400px) { .response-buttons { flex-direction: row; } }
        .response-buttons button { flex: 1; padding: 25px 15px; font-size: 1.3rem; border: 2px solid transparent; border-radius: 18px; }

        #match-btn { background: rgba(46, 204, 113, 0.05); color: #2ecc71; border-color: rgba(46, 204, 113, 0.2); }
        #no-match-btn { background: rgba(231, 76, 60, 0.05); color: #e74c3c; border-color: rgba(231, 76, 60, 0.2); }
        #match-btn:active { background: #2ecc71; color: #000; }
        #no-match-btn:active { background: #e74c3c; color: #fff; }

        /* PROGRESS BAR */
        .timer-container { width: 100%; height: 4px; background: #111; margin-top: 10px; border-radius: 2px; overflow: hidden; }
        #timer-bar { width: 0%; height: 100%; background: #ffd700; transition: width linear; }

        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 20px; }
        .stat-box { background: #08080c; padding: 10px; border-radius: 12px; border: 1px solid #111; }
        .stat-label { font-size: 0.5rem; color: #444; text-transform: uppercase; margin-bottom: 2px; }
        .stat-value { font-size: 1.1rem; font-weight: 900; color: #bf953f; }

        #feedback { font-size: 1.1rem; font-weight: 900; min-height: 24px; letter-spacing: 1px; }
    </style>
</head>
<body>

<main class="container">
    <h1>IMAGI-WORLD</h1>
    
    <div class="controls">
        <div class="control-group">
            <label>N-Back Window: <span id="n-val" style="color:#ffd700">1</span></label>
            <input type="range" id="n-slider" min="1" max="5" value="1">
        </div>

        <div class="control-group">
            <label>Topology Geometry:</label>
            <select id="logic-mode">
                <option value="0">Mode 0: Standard Linear</option>
                <option value="1">Mode 1: Superposition</option>
                <option value="2">Mode 2: Tensor</option>
                <option value="3">Mode 3: Homology</option>
                <option value="4">Mode 4: Interface</option>
            </select>
        </div>

        <div class="control-group">
            <label>Thinking Window (Sec): <span id="spt-val" style="color:#ffd700">8.0</span>s</label>
            <input type="range" id="spt-slider" min="2" max="45" step="0.5" value="8.0">
        </div>

        <div class="button-group">
            <button id="start-btn">Connect Neural Link</button>
            <button id="stop-btn" disabled>Sever</button>
        </div>
    </div>

    <div class="game-area">
        <div id="status" class="status">NEURAL_IDLE</div>
        <div id="feedback"></div>
        <div id="countdown-display"></div>
        <div id="premise-display">AWAITING_INPUT</div>
        
        <div class="response-buttons">
            <button id="match-btn" disabled>MATCH</button>
            <button id="no-match-btn" disabled>NO_MATCH</button>
        </div>

        <div class="timer-container"><div id="timer-bar"></div></div>

        <div class="stats">
            <div class="stat-box"><div class="stat-label">Cycle</div><div id="trial-count" class="stat-value">0</div></div>
            <div class="stat-box"><div class="stat-label">Sync</div><div id="score" class="stat-value">0</div></div>
            <div class="stat-box"><div class="stat-label">Prec</div><div id="accuracy" class="stat-value">0%</div></div>
        </div>
    </div>
</main>

<script type="module">
    const SYMBOLS = "BCDEFGHJKLMNOPQRSTUVWXYZ".split(""); 
    const REL = { N: 'north', S: 'south', E: 'east', W: 'west' };

    class Mulberry32 {
        constructor(seed) { this.state = seed >>> 0; }
        next() {
            let t = this.state += 0x6D2B79F5;
            t = Math.imul(t ^ t >>> 15, t | 1);
            t ^= t + Math.imul(t ^ t >>> 7, t | 61);
            return ((t ^ t >>> 14) >>> 0) / 4294967296;
        }
        choice(arr) { return arr[Math.floor(this.next() * arr.length)]; }
    }

    class NeuralEngine {
        constructor() {
            this.history = [];
            this.score = 0;
            this.total = 0;
            this.running = false;
            this.rng = new Mulberry32(Date.now());
            this.synth = window.speechSynthesis;
        }

        init() {
            document.getElementById('start-btn').onclick = () => this.start();
            document.getElementById('stop-btn').onclick = () => this.stop();
            document.getElementById('n-slider').oninput = (e) => document.getElementById('n-val').textContent = e.target.value;
            document.getElementById('spt-slider').oninput = (e) => document.getElementById('spt-val').textContent = parseFloat(e.target.value).toFixed(1);
            document.getElementById('match-btn').onclick = () => this.respond(true);
            document.getElementById('no-match-btn').onclick = () => this.respond(false);
        }

        speak(t, rate = 0.9) {
            return new Promise((resolve) => {
                this.synth.cancel();
                const u = new SpeechSynthesisUtterance(t);
                u.rate = rate;
                u.onend = () => resolve();
                u.onerror = () => resolve();
                setTimeout(() => this.synth.speak(u), 50);
            });
        }

        async runCountdown() {
            const disp = document.getElementById('countdown-display');
            for (let i = 3; i > 0; i--) {
                disp.textContent = i;
                await this.speak(i.toString(), 1.2);
            }
            disp.textContent = "";
        }

        getOrtho(d1) {
            const v = ['N', 'S'], h = ['E', 'W'];
            return v.includes(d1) ? this.rng.choice(h) : this.rng.choice(v);
        }

        generate(mode, forceMatchKey = null) {
            const rS = () => this.rng.choice(SYMBOLS);
            const rD = () => this.rng.choice(['N', 'S', 'E', 'W']);
            let text, key;

            if (forceMatchKey) {
                key = forceMatchKey;
            } else {
                const d1 = rD(), d2 = this.getOrtho(d1);
                const bridge = rD(), d3 = rD(), d4 = rD(), d5 = rD();
                switch(parseInt(mode)) {
                    case 1: key = `M1-${[d1, d2].sort().join('')}`; break;
                    case 2: key = `M2-${[d1, d2].sort().join('')}`; break;
                    case 3: key = `M3-${d1}-${bridge}`; break;
                    case 4: key = `M4-${d1}${d2}-${d3}${d4}-${d5}`; break;
                    default: key = `M0-${d1}`;
                }
            }

            const p = key.split('-');
            const m = p[0];
            let s1 = rS(), s2 = rS(), s3 = rS();
            while(s2 === s1) s2 = rS();
            while(s3 === s1 || s3 === s2) s3 = rS();

            if (m === 'M1') {
                const ax = p[1].split('');
                text = `${s1} is ${REL[ax[0]]} and ${REL[ax[1]]} of ${s2}`;
            } else if (m === 'M2') {
                const ax = p[1].split('');
                text = `${s1} is ${REL[ax[0]]} of ${s2} and ${REL[ax[1]]} of ${s3}`;
            } else if (m === 'M3') {
                text = `(${REL[p[1]]} of ${s1}) is ${REL[p[2]]} of (${REL[p[1]]} of ${s2})`;
            } else if (m === 'M4') {
                const pA = p[1], pB = p[2], br = p[3];
                text = `(${REL[pA[0]]}-${REL[pA[1]]} of ${s1}) is ${REL[br]} of (${REL[pB[0]]}-${REL[pB[1]]} of ${s2})`;
            } else {
                text = `${s1} is ${REL[p[1]]} of ${s2}`;
            }
            return { text, key };
        }

        start() {
            this.running = true; this.score = 0; this.total = 0; this.history = [];
            document.getElementById('start-btn').disabled = true;
            document.getElementById('stop-btn').disabled = false;
            this.pulse();
        }

        stop() {
            this.running = false;
            clearTimeout(this.timer);
            this.synth.cancel();
            document.getElementById('start-btn').disabled = false;
            document.getElementById('stop-btn').disabled = true;
            document.getElementById('match-btn').disabled = true;
            document.getElementById('no-match-btn').disabled = true;
            document.getElementById('timer-bar').style.width = "0%";
            document.getElementById('status').textContent = "SEVERED";
        }

        async pulse() {
            if (!this.running) return;
            
            const mode = document.getElementById('logic-mode').value;
            const n = parseInt(document.getElementById('n-slider').value);
            const shouldMatch = this.history.length >= n && this.rng.next() < 0.35;
            const nBackObj = shouldMatch ? this.history[this.history.length - n] : null;
            
            let current;
            let safety = 0;
            do {
                current = this.generate(mode, nBackObj ? nBackObj.key : null);
                safety++;
            } while (this.history.length > 0 && current.text === this.history[this.history.length-1].text && safety < 10);

            this.correctIsMatch = (nBackObj !== null && current.key === nBackObj.key);
            this.currentCycleObj = current;
            this.answered = true;

            // UI Reset
            document.getElementById('premise-display').textContent = "SYNCHRONISING...";
            document.getElementById('match-btn').disabled = true;
            document.getElementById('no-match-btn').disabled = true;
            document.getElementById('timer-bar').style.transition = 'none';
            document.getElementById('timer-bar').style.width = '0%';

            // 1. Mandatory Phonetic Countdown (Warms up Hardware)
            await this.runCountdown();

            // 2. Deliver Premise
            document.getElementById('premise-display').textContent = current.text;
            await this.speak(current.text);

            if (!this.running) return;

            // 3. Start Thinking Window
            this.answered = false;
            document.getElementById('match-btn').disabled = false;
            document.getElementById('no-match-btn').disabled = false;
            document.getElementById('status').textContent = `CYCLE_${this.total + 1}_PROCESSING`;

            const spt = parseFloat(document.getElementById('spt-slider').value);
            const bar = document.getElementById('timer-bar');
            bar.style.transition = `width ${spt}s linear`;
            bar.style.width = '100%';

            this.timer = setTimeout(() => { if (!this.answered) this.respond(null); }, spt * 1000);
        }

        respond(val) {
            if (this.answered || !this.running) return;
            this.answered = true;
            clearTimeout(this.timer);

            const bar = document.getElementById('timer-bar');
            bar.style.transition = 'none';
            bar.style.width = '0%';
            
            document.getElementById('match-btn').disabled = true;
            document.getElementById('no-match-btn').disabled = true;

            const fb = document.getElementById('feedback');
            if (val === null) {
                fb.textContent = "TIMEOUT"; fb.className = "incorrect";
            } else if (val === this.correctIsMatch) {
                this.score++; fb.textContent = "SYNC_SUCCESS"; fb.className = "correct";
            } else {
                fb.textContent = "SYNC_ERROR"; fb.className = "incorrect";
            }

            this.total++;
            this.updateUI();
            this.history.push(this.currentCycleObj);
            
            setTimeout(() => { fb.textContent = ""; if (this.running) this.pulse(); }, 1000);
        }

        updateUI() {
            document.getElementById('trial-count').textContent = this.total;
            document.getElementById('score').textContent = this.score;
            document.getElementById('accuracy').textContent = 
                this.total > 0 ? Math.round((this.score / this.total) * 100) + "%" : "0%";
        }
    }

    const engine = new NeuralEngine();
    engine.init();
</script>
</body>
</html>
