<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ðŸŒ€ IMAGI-WORLD: Neural Topology ðŸŒ€</title>
    <style>
        :root {
            --gold: linear-gradient(to right, #bf953f 0%, #fcf6ba 20%, #b38728 40%, #fbf5b7 60%, #aa771c 80%, #bf953f 100%);
            --bg: #020205;
            --panel: #0a0e14;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: var(--bg); 
            color: #eee; 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 15px;
            overflow-x: hidden;
            touch-action: manipulation;
        }

        /* SHINY STAR GOLD TITLE */
        h1 { 
            margin: 20px 0; 
            font-size: clamp(1.8rem, 10vw, 3.2rem); 
            text-align: center; 
            letter-spacing: 5px;
            font-weight: 900;
            background: var(--gold);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            filter: drop-shadow(0 0 12px rgba(255, 215, 0, 0.8));
            text-transform: uppercase;
            animation: shimmer 6s infinite linear;
            background-size: 200% auto;
        }

        @keyframes shimmer { to { background-position: 200% center; } }

        .container { max-width: 600px; width: 100%; }

        .controls { 
            background: var(--panel); 
            padding: 25px; 
            border-radius: 20px; 
            margin-bottom: 20px; 
            border: 1px solid #1a1a1a; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.7); 
        }

        .control-group { margin-bottom: 18px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #ffd700; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1.5px; }

        input[type="range"] { width: 100%; height: 8px; background: #151921; border-radius: 4px; outline: none; -webkit-appearance: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 26px; height: 26px; background: #ffd700; border-radius: 50%; box-shadow: 0 0 15px #ffd700; border: 2px solid #000; cursor: pointer; }

        select { 
            width: 100%; padding: 14px; background: #000; color: #fff; 
            border: 1px solid #333; border-radius: 12px; font-size: 0.9rem; font-weight: 600; outline: none;
        }

        .button-group { display: flex; gap: 12px; margin-top: 15px; }
        button { 
            padding: 18px; border-radius: 14px; border: none; font-weight: 900; 
            cursor: pointer; transition: 0.2s; text-transform: uppercase; 
            touch-action: manipulation;
        }

        #start-btn { flex: 2; background: linear-gradient(135deg, #ffd700, #b38728); color: #000; }
        #stop-btn { flex: 1; background: #121212; color: #e94560; border: 1px solid #401010; }
        button:disabled { opacity: 0.15; pointer-events: none; }

        .game-area { 
            background: #050508; padding: 30px; border-radius: 30px; 
            text-align: center; border: 1px solid #111; min-height: 440px; 
            display: flex; flex-direction: column; justify-content: space-between;
            box-shadow: inset 0 0 40px rgba(0,0,0,0.9);
        }

        .status { font-size: 0.65rem; color: #444; letter-spacing: 5px; font-weight: 900; text-transform: uppercase; margin-bottom: 5px; }
        
        .premise-display { 
            font-size: clamp(1.2rem, 5vw, 1.8rem); color: #fff; margin: 20px 0; font-style: italic; 
            min-height: 120px; display: flex; align-items: center; justify-content: center; 
            line-height: 1.6; text-shadow: 0 0 20px rgba(255,255,255,0.05);
        }

        .response-buttons { display: flex; flex-direction: column; gap: 15px; width: 100%; }
        @media (min-width: 500px) { .response-buttons { flex-direction: row; } }

        .response-buttons button { flex: 1; padding: 30px 20px; font-size: 1.5rem; border: 2px solid transparent; border-radius: 20px; }

        #match-btn { background: rgba(46, 204, 113, 0.05); color: #2ecc71; border-color: rgba(46, 204, 113, 0.2); }
        #no-match-btn { background: rgba(231, 76, 60, 0.05); color: #e74c3c; border-color: rgba(231, 76, 60, 0.2); }
        
        #match-btn:active { background: #2ecc71; color: #000; }
        #no-match-btn:active { background: #e74c3c; color: #fff; }

        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 30px; }
        .stat-box { background: #0a0a0f; padding: 15px; border-radius: 15px; border: 1px solid #111; }
        .stat-label { font-size: 0.55rem; color: #444; text-transform: uppercase; margin-bottom: 5px; font-weight: 800; }
        .stat-value { font-size: 1.2rem; font-weight: 900; color: #bf953f; }

        #feedback { font-size: 1.3rem; font-weight: 900; min-height: 30px; letter-spacing: 2px; }
        .correct { color: #ffd700; text-shadow: 0 0 15px #ffd700; }
        .incorrect { color: #ff4444; }
    </style>
</head>
<body>

<main class="container">
    <h1>IMAGI-WORLD</h1>
    
    <div class="controls">
        <div class="control-group">
            <label>N-Back Lag: <span id="n-val" style="color:#ffd700">1</span></label>
            <input type="range" id="n-slider" min="1" max="5" value="1">
        </div>

        <div class="control-group">
            <label>Topology Geometry:</label>
            <select id="logic-mode">
                <option value="0">Mode 0: Standard Linear</option>
                <option value="1">Mode 1: Dialectical Superposition</option>
                <option value="2">Mode 2: Semantic Tensor</option>
                <option value="3">Mode 3: System Homology</option>
                <option value="4">Mode 4: Complementary Interface</option>
            </select>
        </div>

        <div class="control-group">
            <label>Seconds per Trial: <span id="spt-val" style="color:#ffd700">8.0</span>s</label>
            <input type="range" id="spt-slider" min="2" max="45" step="0.5" value="8.0">
        </div>

        <div class="button-group">
            <button id="start-btn">Initialize link</button>
            <button id="stop-btn" disabled>Sever</button>
        </div>
    </div>

    <div class="game-area">
        <div id="status" class="status">IDLE_SYSTEM</div>
        <div id="feedback"></div>
        <div id="premise-display" class="premise-display">AWAITING_INPUT</div>
        
        <div class="response-buttons">
            <button id="match-btn" disabled>MATCH</button>
            <button id="no-match-btn" disabled>NO_MATCH</button>
        </div>

        <div class="stats">
            <div class="stat-box"><div class="stat-label">Cycle</div><div id="trial-count" class="stat-value">0</div></div>
            <div class="stat-box"><div class="stat-label">Score</div><div id="score" class="stat-value">0</div></div>
            <div class="stat-box"><div class="stat-label">Prec</div><div id="accuracy" class="stat-value">0%</div></div>
        </div>
    </div>
</main>

<script type="module">
    // SYMBOL POOL - ABSOLUTELY NO 'A'
    const SYMBOLS = "BCDEFGHJKLMNOPQRSTUVWXYZ".split(""); 
    const REL = { N: 'north', S: 'south', E: 'east', W: 'west' };

    class Mulberry32 {
        constructor(seed) { this.state = seed >>> 0; }
        next() {
            let t = this.state += 0x6D2B79F5;
            t = Math.imul(t ^ t >>> 15, t | 1);
            t ^= t + Math.imul(t ^ t >>> 7, t | 61);
            return ((t ^ t >>> 14) >>> 0) / 4294967296;
        }
        choice(arr) { return arr[Math.floor(this.next() * arr.length)]; }
    }

    class DaVinciEngine {
        constructor() {
            this.history = [];
            this.score = 0;
            this.total = 0;
            this.running = false;
            this.rng = new Mulberry32(Date.now());
            this.synth = window.speechSynthesis;
        }

        init() {
            document.getElementById('start-btn').onclick = () => this.start();
            document.getElementById('stop-btn').onclick = () => this.stop();
            document.getElementById('n-slider').oninput = (e) => document.getElementById('n-val').textContent = e.target.value;
            document.getElementById('spt-slider').oninput = (e) => document.getElementById('spt-val').textContent = parseFloat(e.target.value).toFixed(1);
            document.getElementById('match-btn').onclick = () => this.respond(true);
            document.getElementById('no-match-btn').onclick = () => this.respond(false);

            window.addEventListener('keydown', (e) => {
                if (!this.running) return;
                if (e.code === 'Space') { e.preventDefault(); this.respond(true); }
                if (e.code === 'Enter') { e.preventDefault(); this.respond(false); }
            });
        }

        speak(t) {
            this.synth.cancel();
            const u = new SpeechSynthesisUtterance(t);
            u.rate = 0.9; u.pitch = 1.0;
            this.synth.speak(u);
        }

        generate(mode, forceMatchKey = null) {
            const rS = () => this.rng.choice(SYMBOLS);
            const rD = () => this.rng.choice(['N', 'S', 'E', 'W']);
            const ortho = (d) => (d === 'N' || d === 'S') ? this.rng.choice(['E', 'W']) : this.rng.choice(['N', 'S']);

            let text, key;

            if (forceMatchKey) {
                key = forceMatchKey;
            } else {
                switch(mode) {
                    case 1: key = `M1-${rD()}-${ortho('N')}`; break; // Placeholder ortho
                    case 2: key = `M2-${rD()}-${ortho('N')}`; break;
                    case 3: key = `M3-${rD()}-${rD()}`; break;
                    case 4: key = `M4-${rD()}${rD()}-${rD()}${rD()}-${rD()}`; break;
                    default: key = `M0-${rD()}`;
                }
            }

            const p = key.split('-');
            const m = p[0];
            let s1 = rS(), s2 = rS(), s3 = rS();
            while(s2 === s1) s2 = rS();
            while(s3 === s1 || s3 === s2) s3 = rS();

            try {
                if (m === 'M1') {
                    text = `${s1} is ${REL[p[1]]} and ${REL[p[2]]} of ${s2}`;
                } else if (m === 'M2') {
                    text = `${s1} is ${REL[p[1]]} of ${s2} and ${REL[p[2]]} of ${s3}`;
                } else if (m === 'M3') {
                    text = `(${REL[p[1]]} of ${s1}) is ${REL[p[2]]} of (${REL[p[1]]} of ${s2})`;
                } else if (m === 'M4') {
                    text = `(${REL[p[1][0]]}-${REL[p[1][1]]} of ${s1}) is ${REL[p[3]]} of (${REL[p[2][0]]}-${REL[p[2][1]]} of ${s2})`;
                } else {
                    text = `${s1} is ${REL[p[1]]} of ${s2}`;
                }
            } catch(e) {
                text = `${s1} is north of ${s2}`; // Fallback logic
            }

            return { text, key };
        }

        start() {
            this.running = true; this.score = 0; this.total = 0; this.history = [];
            document.getElementById('start-btn').disabled = true;
            document.getElementById('stop-btn').disabled = false;
            document.getElementById('match-btn').disabled = false;
            document.getElementById('no-match-btn').disabled = false;
            this.pulse();
        }

        stop() {
            this.running = false;
            clearTimeout(this.timer);
            document.getElementById('start-btn').disabled = false;
            document.getElementById('stop-btn').disabled = true;
            document.getElementById('match-btn').disabled = true;
            document.getElementById('no-match-btn').disabled = true;
            document.getElementById('status').textContent = "SEVERED";
        }

        pulse() {
            if (!this.running) return;
            const mode = parseInt(document.getElementById('logic-mode').value);
            const n = parseInt(document.getElementById('n-slider').value);
            
            const shouldMatch = this.history.length >= n && this.rng.next() < 0.38;
            const nBackObj = shouldMatch ? this.history[this.history.length - n] : null;
            
            let current = this.generate(mode, nBackObj ? nBackObj.key : null);

            // Verification: If we didn't want a match, ensure we didn't accidentally get one
            if (!shouldMatch && nBackObj && current.key === nBackObj.key) {
                current = this.generate(mode); // Re-roll
            }

            this.correctIsMatch = (nBackObj !== null && current.key === nBackObj.key);
            this.currentCycleObj = current;

            document.getElementById('premise-display').textContent = current.text;
            this.speak(current.text);

            this.total++;
            this.updateUI();

            this.answered = false;
            const limit = parseFloat(document.getElementById('spt-slider').value) * 1000;
            this.timer = setTimeout(() => { if (!this.answered) this.respond(null); }, limit);
        }

        respond(val) {
            if (this.answered || !this.running) return;
            this.answered = true;
            clearTimeout(this.timer);

            const fb = document.getElementById('feedback');
            if (val === null) {
                fb.textContent = "TIMEOUT"; fb.className = "incorrect";
            } else if (val === this.correctIsMatch) {
                this.score++; fb.textContent = "SYNC_SUCCESS"; fb.className = "correct";
            } else {
                fb.textContent = "SYNC_ERROR"; fb.className = "incorrect";
            }

            this.history.push(this.currentCycleObj);
            setTimeout(() => { fb.textContent = ""; this.pulse(); }, 1000);
        }

        updateUI() {
            document.getElementById('trial-count').textContent = this.total;
            document.getElementById('score').textContent = this.score;
            document.getElementById('accuracy').textContent = 
                this.total > 1 ? Math.round((this.score / (this.total - 1)) * 100) + "%" : "0%";
            document.getElementById('status').textContent = `CYCLE_${this.total}_ACTIVE`;
        }
    }

    const engine = new DaVinciEngine();
    engine.init();
</script>
</body>
</html>
